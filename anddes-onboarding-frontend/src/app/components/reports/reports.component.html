<div class="reports-page">
  <div class="filters-header">
    <button
      mat-icon-button
      color="primary"
      class="download-button"
      type="button"
      aria-label="Descargar Excel"
      (click)="downloadExcel()"
    >
      <mat-icon>file_download</mat-icon>
    </button>

    <mat-form-field class="borderless-field" appearance="fill">
      <mat-label>Tipo de reporte</mat-label>
      <mat-select [formControl]="typeControl">
        <mat-option *ngFor="let option of reportTypes" [value]="option.value">
          {{ option.label }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field class="borderless-field" appearance="fill">
      <mat-label>Periodo</mat-label>
      <mat-select [formControl]="periodControl">
        <mat-select-trigger>
          {{ formatPeriodLabel() }}
        </mat-select-trigger>
        <mat-option *ngFor="let option of periodOptions" [value]="option.value">
          {{ option.label }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field class="borderless-field" appearance="fill">
      <mat-label>Estado</mat-label>
      <mat-select [formControl]="stateControl">
        <mat-option *ngFor="let option of stateOptions" [value]="option.value">
          {{ option.label }}
        </mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <div class="filters">
    <mat-form-field class="search-field" appearance="outline">
      <mat-label>Buscar por usuario</mat-label>
      <input matInput [formControl]="searchControl" placeholder="Nombre o correo" />
      <button
        mat-icon-button
        matSuffix
        type="button"
        aria-label="Limpiar bÃºsqueda"
        *ngIf="searchControl.value"
        (click)="clearSearch()"
      >
        <mat-icon>close</mat-icon>
      </button>
    </mat-form-field>
  </div>

  <mat-progress-bar *ngIf="isLoading" mode="indeterminate"></mat-progress-bar>

  <div class="table-wrapper">
    <table
      mat-table
      [dataSource]="dataSource"
      matSort
      matSortActive="fullName"
      matSortDisableClear
      matSortDirection="asc"
      class="mat-elevation-z1"
    >
      <ng-container matColumnDef="dni" *ngIf="isGeneral">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>DNI</th>
        <td mat-cell *matCellDef="let row">{{ row.dni }}</td>
      </ng-container>

      <ng-container matColumnDef="fullName">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Usuario</th>
        <td mat-cell *matCellDef="let row">{{ row.fullName }}</td>
      </ng-container>

      <ng-container matColumnDef="position" *ngIf="isMatrix">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Cargo</th>
        <td mat-cell *matCellDef="let row">{{ row.position }}</td>
      </ng-container>

      <ng-container matColumnDef="progress" *ngIf="isGeneral">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Avance</th>
        <td mat-cell *matCellDef="let row">{{ getProgressLabel(row) }}</td>
      </ng-container>

      <ng-container matColumnDef="state" *ngIf="isElearning">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Estado</th>
        <td mat-cell *matCellDef="let row">
          <span [class]="stateClass(resolveState(row))">{{ stateLabel(resolveState(row)) }}</span>
        </td>
      </ng-container>

      <ng-container matColumnDef="startDate" *ngIf="isGeneral">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Fecha de inicio</th>
        <td mat-cell *matCellDef="let row">{{ row.startDate | date: 'shortDate' }}</td>
      </ng-container>

      <ng-container matColumnDef="finishDate" *ngIf="isGeneral">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Fecha de fin</th>
        <td mat-cell *matCellDef="let row">{{ row.finishDate | date: 'shortDate' }}</td>
      </ng-container>

      <ng-container matColumnDef="totalCourses" *ngIf="isElearning">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Cursos</th>
        <td mat-cell *matCellDef="let row">{{ row.totalCourses }}</td>
      </ng-container>

      <ng-container matColumnDef="approvedCourses" *ngIf="isElearning">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Completados</th>
        <td mat-cell *matCellDef="let row">{{ row.approvedCourses }}</td>
      </ng-container>

      <ng-container matColumnDef="averageScore" *ngIf="isElearning">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Promedio</th>
        <td mat-cell *matCellDef="let row">{{ row.averageScore | number: '1.0-1' }}</td>
      </ng-container>

      <ng-container matColumnDef="updatedAt" *ngIf="isElearning || isMatrix">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Actualizado</th>
        <td mat-cell *matCellDef="let row">{{ row.updatedAt | date: 'short' }}</td>
      </ng-container>

      <ng-container matColumnDef="area" *ngIf="isMatrix">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>\u00c1rea</th>
        <td mat-cell *matCellDef="let row">{{ row.area }}</td>
      </ng-container>

      <ng-container matColumnDef="matrixStatus" *ngIf="isMatrix">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Estado matriz</th>
        <td mat-cell *matCellDef="let row">{{ row.matrixStatus }}</td>
      </ng-container>

      <ng-container matColumnDef="actions" *ngIf="isGeneral || isElearning">
        <th mat-header-cell *matHeaderCellDef class="actions-header">Acciones</th>
        <td mat-cell *matCellDef="let row" class="actions-cell">
          <button
            mat-stroked-button
            color="primary"
            type="button"
            *ngIf="isGeneral"
            (click)="openGeneralDetail(row)"
          >
            <mat-icon>checklist</mat-icon>
            Actividades
          </button>
          <button
            mat-stroked-button
            color="primary"
            type="button"
            *ngIf="isElearning"
            (click)="openElearningDetail(row)"
          >
            <mat-icon>school</mat-icon>
            Detalle
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr
        mat-row
        *matRowDef="let row; columns: displayedColumns"
        class="data-row"
        [ngClass]="{ 'delayed-row': row.delayed }"
      ></tr>
      <tr class="mat-row" *matNoDataRow>
        <td class="no-data" [attr.colspan]="displayedColumns.length">No se encontraron resultados</td>
      </tr>
    </table>

    <mat-paginator [length]="resultsLength" [pageSize]="10" [pageSizeOptions]="[10, 25, 50]"></mat-paginator>
  </div>
</div>
